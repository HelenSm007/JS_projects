<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch запросы</title>
    <style>
        .correct-answer{
            font-weight: bold;
            color: green;
        }

    </style>
</head>
<body>
    <button class="get-result"> Get Result </button>
    <button class="get-pass"> Get Password </button>
    <section class="test-result"></section>
    <section class="tests"> </section>

    <script>
        let buttonRes = document.querySelector('button.get-result'),
            buttonPass = document.querySelector('button.get-pass');
        //вывод результата теста
        buttonRes.addEventListener('click', () => {
            //GET-запрос по ссылке https://votesystem.mobius.team/api/result/{USER_ID}
          //  getResultTestById (40);
          try{
            (async () => {
                let request = generateRequest();
                for await (let value of request ){
                    value;
                }
            })();
            // request.next().value;
            // request.throw(new Error("Error!!!"));

          } catch (error) {
            alert(error.message);
          }
        });

        /* получение password */
        buttonPass.addEventListener('click', () => {
            let lengthPass = prompt('Какой длины пароль?', 0);
            getPass(lengthPass);
        });

        const url = 'https://votesystem.mobius.team';
        
        //********* Async Generator ************
        
        async function* generateRequest() {
            yield getTests();
            yield getResultTestById (40);
            yield getToken (40);
        }
        // ************************

        // ***** Генерация пароля******

        function randomInteger(min, max) {
            // случайное число от min до (max+1)
            let rand
            do {
                rand =  Math.floor(min + Math.random() * (max + 1 - min));

            } while ((rand > 57 && rand < 65) || (rand > 90 && rand < 97));

            return rand;
        }

        function* generatePasswordCodes(length) {
            for (let i = 0; i < length; i++) {
                yield randomInteger(48, 122);
            }
            /*
        // 0..9
        yield* generateSequence(48, 57);

        // A..Z
        yield* generateSequence(65, 90);

        // a..z
        yield* generateSequence(97, 122);
        */
        }

        function getPass(length){
            let str = '';

            for(let code of generatePasswordCodes(length)) {
            console.log (code);
            str += String.fromCharCode(code);
            }

            alert(str); // 0..9A..Za..z
        }

        // *********************************

        let getToken = (userId) => {
            fetch(`${url}/api/result/${userId}/token`)
                .then(response => response.json())
                    .then(result => {
                        alert(result.message);
                        console.log(result);
                        return result.token;
                        // console.log(token);
                    })
                    .then( token => {
                        let formData = new FormData();
                        formData.set('token', token);
                        formData.set('homework_done', true);
                        
                       fetch(`${url}/api/homework/update`, {
                            method: 'POST',
                            body: formData
                        })

                    })
                    .catch((error) => {  
                        alert('Request failed', error);  
                    });
        };

        async function getResultTestById (userId) {
            let response = await fetch(url + '/api/result/' + userId);
            
            if (response.ok) { // если HTTP-статус в диапазоне 200-299
                // получаем тело ответа
                let result = await response.json();
                console.log(result);// читает тело ответа в формате JSON
                alert(result.message);
                showResultById(result);
            } else {
                alert("Ошибка HTTP: " + response.status);
            }
        };

        let showResultById = (jsonObj) => {
            var user = jsonObj['user'];
    
            let nameUser = document.createElement('h2'),
                resultUser= document.createElement('p'),
                section = document.querySelector('.test-result');
                
            nameUser.textContent = user.name;
            resultUser.textContent = 'Результат: ' + user.result + '%';

            section.appendChild(nameUser);
            section.appendChild(resultUser);
        };

        async function getTests () {
            let response = await fetch(url + '/api/tests'); //возвращает объект с заголовками ответа типа Promise
            
            if (response.ok) { // если HTTP-статус в диапазоне 200-299
                // получаем тело ответа
                let result = await response.json();// читает тело ответа в формате JSON
                // console.log(result);
                alert(result.message);
                showTests(result);
            } else {
                alert("Ошибка HTTP: " + response.status);
            }
        };
        
        function showTests(jsonObj){
            var tests = jsonObj['tests'];
            
            for (let test of tests){
                // console.log(test);
                let myArticle = document.createElement('article'),
                    testH2 = document.createElement('h2'),
                    testQuestion = document.createElement('h3'),
                    optionsList = document.createElement('ul'),
                    sectionTests = document.querySelector('.tests');
                
                testH2.textContent = test.label;
                testQuestion.textContent = test.text;

                for (let item of test.conditions){
                    listItem = document.createElement('li');
                    listItem.textContent = item.text;
                    if ( item.is_correct ) {
                        listItem.classList.add('correct-answer');
                    }
                    optionsList.appendChild(listItem);
                }

                //Добавление тегов с информацией в html
                myArticle.appendChild(testH2);
                myArticle.appendChild(testQuestion);
                myArticle.appendChild(optionsList);
                
                sectionTests.appendChild(myArticle);

            }
        };
       // getTests();
    </script>
</body>
</html>